<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borsa Istanbul Stock Analysis</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
    <h1>Borsa Istanbul Stock Analysis</h1>
    <div id="output"></div>
    <py-script>
        import asyncio
        import micropip

        async def main():
            # Function to install libraries using micropip
            async def install_libraries():
                try:
                    # Attempt to install only essential libraries
                    await micropip.install("numpy")
                    await micropip.install("pandas")
                    await micropip.install("matplotlib")
                    # Remove yfinance if not supported
                except ValueError as e:
                    # If installation fails, catch the exception and print it
                    print(f"Error installing packages: {e}")

            # Run the installation
            await install_libraries()

            import numpy as np
            import pandas as pd
            import matplotlib.pyplot as plt
            from datetime import datetime

            # List of Borsa Istanbul tickers (example tickers, update with actual tickers)
            bist_tickers = [
                'GARAN.IS', 'ASELS.IS', 'EREGL.IS', 'ISCTR.IS', 'SISAS.IS', 'PETKM.IS', 'YAPIKRED.IS',
                'SAHOL.IS', 'THYAO.IS', 'KCHOL.IS', 'FROTO.IS', 'TOASO.IS', 'BIMAS.IS', 'KRDMD.IS'
                # Add more Borsa Istanbul tickers here
            ]

            # Placeholder function to fetch stock data (update with a supported method)
            def fetch_stock_data(ticker, start_date, end_date):
                # This is a placeholder. Implement a supported method to fetch stock data.
                print(f"Fetching data for {ticker} from {start_date} to {end_date}")
                return pd.DataFrame()  # Return an empty DataFrame for now

            # Function to calculate Fibonacci retracement levels
            def calculate_fibonacci_levels(data):
                high = data['High'].max()
                low = data['Low'].min()

                diff = high - low
                levels = {
                    '0%': low,
                    '23.6%': high - 0.236 * diff,
                    '38.2%': high - 0.382 * diff,
                    '50%': high - 0.5 * diff,
                    '61.8%': high - 0.618 * diff,
                    '78.6%': high - 0.786 * diff,
                    '100%': high
                }
                return levels

            # Function to find the closest Fibonacci level to the current price
            def find_closest_fibonacci_level(current_price, levels):
                closest_level = min(levels.values(), key=lambda x: abs(x - current_price))
                return closest_level

            # Function to generate prediction message
            def generate_prediction_message(current_price, closest_fib):
                if current_price < closest_fib:
                    if (closest_fib - current_price) / current_price > 0.3:
                        message = (f"Currently, the stock is trading at ${current_price:.2f}. "
                                   f"The nearest Fibonacci level is at ${closest_fib:.2f}. If the stock reaches ${closest_fib:.2f}, "
                                   f"it will break through the Fibonacci level, potentially leading to an incredible increase. "
                                   f"This could signal a strong bullish trend and offer significant upside potential.")
                    else:
                        message = (f"Currently, the stock is trading at ${current_price:.2f}. "
                                   f"The nearest Fibonacci level is at ${closest_fib:.2f}. If the stock reaches ${closest_fib:.2f}, "
                                   f"it will break through the Fibonacci level, potentially leading to a slight increase. "
                                   f"This could indicate a potential upward movement.")
                else:
                    if (current_price - closest_fib) / current_price > 0.3:
                        message = (f"Currently, the stock is trading at ${current_price:.2f}. "
                                   f"The nearest Fibonacci level is at ${closest_fib:.2f}. If the stock falls below ${closest_fib:.2f}, "
                                   f"it might lead to an incredible decrease. This could signal a strong bearish trend and a significant decline.")
                    else:
                        message = (f"Currently, the stock is trading at ${current_price:.2f}. "
                                   f"The nearest Fibonacci level is at ${closest_fib:.2f}. If the stock falls below ${closest_fib:.2f}, "
                                   f"it might lead to a slight decrease. This could indicate a potential downward movement.")
                return message

            # Visualization function
            def plot_stock_data(data, levels, ticker):
                plt.figure(figsize=(14, 7))
                plt.plot(data['Close'], label='Close Price', color='black')

                for level, price in levels.items():
                    plt.axhline(price, linestyle='--', label=f'Fibonacci {level}', alpha=0.5)

                plt.title(f'Stock Price with Fibonacci Levels for {ticker}')
                plt.legend()
                plt.show()

            # Main function to execute the complete analysis
            async def analyze_stock(ticker_name, ticker_symbol):
                # Step 1: Fetch data
                start_date = "2023-06-01"
                end_date = "2024-06-01"
                data = fetch_stock_data(ticker_symbol, start_date, end_date)

                if data.empty:
                    print(f"No data found for {ticker_name} ({ticker_symbol})")
                    return

                # Step 2: Calculate Fibonacci levels
                levels = calculate_fibonacci_levels(data)

                # Step 3: Find the current price and closest Fibonacci level
                current_price = data['Close'].iloc[-1] if not data.empty else 0
                closest_fib = find_closest_fibonacci_level(current_price, levels)

                # Step 4: Generate prediction message
                prediction_message = generate_prediction_message(current_price, closest_fib)
                print(prediction_message)

                # Step 5: Visualization
                plot_stock_data(data, levels, ticker_name)

            # Run the analysis for all Borsa Istanbul stocks
            for ticker in bist_tickers:
                asyncio.ensure_future(analyze_stock(ticker, ticker))

        # Run the main function
        asyncio.ensure_future(main())
    </py-script>
</body>
</html>
